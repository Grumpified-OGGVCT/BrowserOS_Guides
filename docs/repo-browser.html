<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; script-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self' http://localhost:3100 ws://localhost:3100; frame-ancestors 'none'; base-uri 'self'; form-action 'self';">
    <title>BrowserOS_Guides Repository Browser</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0066cc;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-bg: #f8f9fa;
            --dark-bg: #343a40;
            --border-color: #dee2e6;
            
            /* BrowserOS Colors */
            --browseros-blue: #0066CC;
            --browseros-orange: #FF7900;
            --browseros-orange-light: #FF9D4D;
            --browseros-orange-dark: #CC6100;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --bg-elevated: #ffffff;
            
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-tertiary: #868e96;
            --text-inverse: #ffffff;
            
            --border-primary: #dee2e6;
            --border-secondary: #ced4da;
            
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-orange: 0 4px 12px rgba(255, 121, 0, 0.25);
            
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --radius-xl: 12px;
            
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-12: 3rem;
            
            --transition-fast: 150ms ease;
            --transition-base: 250ms ease;
            --transition-smooth: 350ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        .repo-browser {
            padding: var(--space-8) 0;
            background: var(--bg-secondary);
            min-height: calc(100vh - 70px);
        }
        
        .browser-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--space-4);
        }
        
        .browser-header {
            margin-bottom: var(--space-6);
        }
        
        .browser-header h1 {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: 2rem;
            margin-bottom: var(--space-2);
            color: var(--text-primary);
        }
        
        .browser-header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            max-width: 600px;
        }
        
        .browser-stats {
            display: flex;
            gap: var(--space-6);
            margin-top: var(--space-4);
        }
        
        .browser-stat {
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-primary);
            box-shadow: var(--shadow-sm);
        }
        
        .browser-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--browseros-orange);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .browser-stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }
        
        .browser-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: var(--space-6);
            height: 800px;
            background: var(--bg-primary);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-primary);
            overflow: hidden;
        }
        
        .file-tree {
            border-right: 1px solid var(--border-primary);
            padding: var(--space-4);
            overflow-y: auto;
            max-height: 800px;
            background: var(--bg-primary);
        }
        
        .file-tree-item {
            padding: var(--space-2) var(--space-3);
            margin: var(--space-1) 0;
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8125rem;
            display: flex;
            align-items: center;
            gap: var(--space-2);
            color: var(--text-secondary);
        }
        
        .file-tree-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .file-tree-item.active {
            background: rgba(255, 121, 0, 0.15);
            color: var(--browseros-orange);
            border: 1px solid rgba(255, 121, 0, 0.3);
            box-shadow: 0 0 8px rgba(255, 121, 0, 0.2);
        }
        
        .file-tree-item.folder {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .file-tree-item.file {
            /* padding-left handled dynamically */
        }
        
        .file-tree-item .icon {
            font-size: 1rem;
            flex-shrink: 0;
        }
        
        .file-preview {
            padding: var(--space-8);
            overflow-y: auto;
            max-height: 800px;
        }
        
        .preview-header {
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-6);
            border-bottom: 1px solid var(--border-primary);
        }
        
        .preview-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }
        
        .preview-content {
            font-size: 0.9375rem;
            line-height: 1.7;
            font-family: 'JetBrains Mono', monospace;
            white-space: pre-wrap;
            background: var(--bg-secondary);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-secondary);
            overflow-x: auto;
        }

        .preview-content code {
            font-family: inherit;
        }
        
        .search-box {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border: 1px solid var(--border-secondary);
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            font-family: 'Inter', sans-serif;
            margin-bottom: var(--space-4);
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all var(--transition-fast);
        }
        
        .search-box::placeholder {
            color: var(--text-tertiary);
        }
        
        .search-box:focus {
            outline: none;
            border-color: var(--browseros-orange);
            background: var(--bg-tertiary);
            box-shadow: 0 0 0 3px rgba(255, 121, 0, 0.1);
        }
        
        .folder-toggle {
            cursor: pointer;
            user-select: none;
        }
        
        .folder-contents {
            /* Handled by JS toggling */
        }
        
        .folder-contents.collapsed {
            display: none;
        }
        
        .empty-state {
            text-align: center;
            padding: var(--space-12) var(--space-6);
            color: var(--text-tertiary);
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            color: var(--text-primary);
            text-decoration: none;
            margin-bottom: var(--space-6);
            font-weight: 600;
            padding: var(--space-2) var(--space-4);
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: var(--radius-lg);
            transition: all var(--transition-base);
            font-size: 0.9375rem;
        }
        
        .back-link:hover {
            background: var(--bg-tertiary);
            border-color: var(--browseros-orange);
            color: var(--browseros-orange);
            transform: translateX(-4px);
        }

        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: var(--browseros-orange);
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 968px) {
            .browser-content {
                grid-template-columns: 1fr;
            }
            
            .file-tree {
                border-right: none;
                border-bottom: 1px solid var(--border-primary);
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <span class="logo">üöÄ</span>
                <span class="brand-name">BrowserOS Knowledge Hub</span>
            </div>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="index.html#workflows">Workflows</a></li>
                <li><a href="index.html#knowledge-base">Knowledge Base</a></li>
                <li><a href="repo-browser.html" class="active">Repository Browser</a></li>
                <!-- GitHub link removed -->
            </ul>
        </div>
    </nav>

    <!-- Repository Browser -->
    <section class="repo-browser">
        <div class="browser-container">
            <a href="index.html" class="back-link">
                ‚Üê Back to Home
            </a>
            
            <div class="browser-header">
                <h1>
                    <span>üìÇ</span>
                    BrowserOS_Guides Repository Browser
                </h1>
                <p>Browse and explore the local repository structure</p>
                
                <div class="browser-stats">
                    <div class="browser-stat">
                        <span class="browser-stat-value" id="file-count">0</span>
                        <span class="browser-stat-label">Files</span>
                    </div>
                    <div class="browser-stat">
                        <span class="browser-stat-value" id="folder-count">0</span>
                        <span class="browser-stat-label">Folders</span>
                    </div>
                </div>
            </div>
            
            <div class="browser-content">
                <div class="file-tree">
                    <input type="text" class="search-box" id="search-box" placeholder="Search files...">
                    <div id="file-tree-container">
                        <!-- Tree rendered here -->
                    </div>
                </div>
                
                <div class="file-preview">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÑ</div>
                        <h3>Select a file to view content</h3>
                        <p>Click on any file in the tree to view its contents here.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        // Configuration
        const API_BASE_URL = window.location.protocol === 'file:' 
            ? 'http://localhost:3100' 
            : `${window.location.protocol}//${window.location.hostname}:3100`;

        // State
        let rootNode = null;

        // MCP Client Helper
        async function callMcpTool(toolName, args = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}/mcp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tool: toolName, parameters: args })
                });

                if (!response.ok) {
                    throw new Error(`MCP Server Error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                
                if (!result.success && result.isError) {
                    throw new Error(result.content?.[0]?.text || 'Unknown MCP error');
                }
                
                // Parse the inner JSON content if it's a string (common pattern in our tools)
                let data = result.data || result.content?.[0]?.text;
                if (typeof data === 'string') {
                    try {
                        data = JSON.parse(data);
                    } catch (e) {
                        // Keep as string if not JSON
                    }
                }
                
                return data;
            } catch (error) {
                console.error(`MCP Tool Call Failed (${toolName}):`, error);
                throw error;
            }
        }

        // Initialize - Load Root
        document.addEventListener('DOMContentLoaded', async () => {
            await loadRepoStructure();
            
            // Search listener (simple filter for visible items)
            document.getElementById('search-box').addEventListener('input', (e) => {
               const searchTerm = e.target.value.toLowerCase();
               const items = document.querySelectorAll('.file-tree-item');
               items.forEach(item => {
                   if (item.classList.contains('folder')) return; 
                   const name = item.querySelector('span:last-child').textContent.toLowerCase();
                   item.style.display = name.includes(searchTerm) ? 'flex' : 'none';
               });
            });
        });

        async function loadRepoStructure() {
            const container = document.getElementById('file-tree-container');
            container.innerHTML = '<div class="loading-spinner"></div> Loading local repository...';

            try {
                // Fetch root directory
                const rootData = await callMcpTool('list_directory', { path: '' });
                rootNode = rootData;
                
                updateStats(rootNode.children);

                container.innerHTML = '';
                renderFileTree(rootNode, container);
                
                updateGenerationInfo(new Date().toISOString());

            } catch (error) {
                container.innerHTML = `
                    <div style="color: var(--danger-color); padding: 1rem;">
                        <strong>‚ö†Ô∏è Local Server Error</strong><br>
                        Could not pull file list from MCP server.<br>
                        Ensure server is running: <code>npm run mcp-server</code><br>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        function updateStats(children) {
            // Count immediate children
            const files = children.filter(c => c.type === 'file').length;
            const folders = children.filter(c => c.type === 'folder').length;
            
            document.getElementById('file-count').textContent = files + '+';
            document.getElementById('folder-count').textContent = folders + '+';
        }

        function renderFileTree(node, container, level = 0) {
            if (!node || !node.children) return;

            node.children.forEach(child => {
                const item = document.createElement('div');
                item.className = `file-tree-item ${child.type === 'folder' ? 'folder' : 'file'}`;
                item.style.paddingLeft = `${level * 20 + 12}px`;
                item.setAttribute('role', 'button');
                item.setAttribute('tabindex', '0');
                
                // Icon
                const icon = document.createElement('span');
                icon.className = 'icon';
                icon.textContent = child.type === 'folder' ? 'üìÅ' : getFileIcon(child.name);
                item.appendChild(icon);

                // Name
                const nameSpan = document.createElement('span');
                nameSpan.textContent = child.name;
                item.appendChild(nameSpan);

                // Container for children (if folder)
                let childrenContainer = null;

                if (child.type === 'folder') {
                    item.classList.add('folder-toggle');
                    childrenContainer = document.createElement('div');
                    childrenContainer.className = 'folder-contents collapsed';
                    
                    const toggle = async (e) => {
                        e.stopPropagation();
                        childrenContainer.classList.toggle('collapsed');
                        const isExpanded = !childrenContainer.classList.contains('collapsed');
                        icon.textContent = isExpanded ? 'üìÇ' : 'üìÅ';

                        // Lazy Load if empty and expanding
                        if (isExpanded && childrenContainer.children.length === 0) {
                            await loadFolderContents(child, childrenContainer, level + 1);
                        }
                    };

                    item.onclick = toggle;
                    item.onkeydown = (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            toggle(e);
                        }
                    };

                } else {
                    // File click -> Preview
                    const select = (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('.file-tree-item').forEach(el => el.classList.remove('active'));
                        item.classList.add('active');
                        showFilePreview(child);
                    };

                    item.onclick = select;
                    item.onkeydown = (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            select(e);
                        }
                    };
                }

                container.appendChild(item);
                if (childrenContainer) {
                    container.appendChild(childrenContainer);
                }
            });
        }

        async function loadFolderContents(folderNode, container, level) {
            const loadingItem = document.createElement('div');
            loadingItem.className = 'file-tree-item';
            loadingItem.style.paddingLeft = `${level * 20 + 12}px`;
            loadingItem.style.color = 'var(--text-tertiary)';
            loadingItem.innerHTML = 'All ‚è≥ Loading...';
            container.appendChild(loadingItem);

            try {
                const data = await callMcpTool('list_directory', { path: folderNode.path });
                loadingItem.remove();

                // Update folder node with new children data
                folderNode.children = data.children;
                renderFileTree(folderNode, container, level);

            } catch (error) {
                loadingItem.innerHTML = `<span style="color: var(--danger-color)">‚ö†Ô∏è Error loading</span>`;
            }
        }

        async function showFilePreview(file) {
            const previewContainer = document.querySelector('.file-preview');
            
            // Clear previous content
            previewContainer.innerHTML = `
                <div class="preview-header">
                    <div class="preview-title">
                        <span>${getFileIcon(file.name)}</span>
                        ${file.name}
                    </div>
                     <div class="preview-meta">
                        <span>üìÇ ${file.path}</span>
                        <span>üìù ${getFileType(file.name)}</span>
                        <span>üìä ${formatSize(file.size || 0)}</span>
                    </div>
                </div>
                <div class="preview-content">
                    <div class="loading-spinner" style="margin: 2rem auto;"></div>
                </div>
            `;

            try {
                const data = await callMcpTool('read_file', { path: file.path });
                const contentDiv = previewContainer.querySelector('.preview-content');
                
                const extension = file.name.split('.').pop().toLowerCase();
                const imageExts = ['png', 'jpg', 'jpeg', 'gif', 'svg', 'ico'];
                
                if (imageExts.includes(extension)) {
                    contentDiv.innerHTML = `
                        <div style="padding: 2rem; text-align: center; color: var(--text-secondary);">
                            <p>üñºÔ∏è Image Preview</p>
                            <p>Binary file display not supported in text mode.</p>
                        </div>
                    `;
                } else {
                    // Escape HTML
                    const safeContent = (data.content || '')
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;");

                    contentDiv.innerHTML = `<pre><code>${safeContent}</code></pre>`;
                }

            } catch (error) {
                const contentDiv = previewContainer.querySelector('.preview-content');
                contentDiv.innerHTML = `
                    <div style="padding: 2rem; color: var(--danger-color); text-align: center;">
                        <h3>Unable to read file</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function getFileIcon(filename) {
            if (filename.endsWith('.md')) return 'üìÑ';
            if (filename.endsWith('.json')) return 'üìã';
            if (filename.endsWith('.py')) return 'üêç';
            if (filename.endsWith('.yml') || filename.endsWith('.yaml')) return '‚öôÔ∏è';
            if (filename.endsWith('.html')) return 'üåê';
            if (filename.endsWith('.css')) return 'üé®';
            if (filename.endsWith('.js')) return 'üìú';
            if (filename.endsWith('.ps1')) return 'üíª';
            return 'üìÑ';
        }

        function getFileType(filename) {
            if (!filename.includes('.')) return 'File';
            return filename.split('.').pop().toUpperCase() + ' File';
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }

        function updateGenerationInfo(timestamp) {
            const browserHeader = document.querySelector('.browser-header');
            if (browserHeader.querySelector('.local-indicator')) return;

            const infoDiv = document.createElement('div');
            infoDiv.className = 'local-indicator';
            infoDiv.style.cssText = 'margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--border-primary); font-size: 0.875rem; color: var(--success-color); display: flex; align-items: center; gap: 0.5rem;';
            
            infoDiv.innerHTML = `
                <span>üü¢</span>
                <strong>Live Local Connection</strong>
                <span style="color: var(--text-secondary);">| Reading directly from disk via MCP</span>
            `;
            
            browserHeader.appendChild(infoDiv);
        }
    </script>
</body>
</html>
