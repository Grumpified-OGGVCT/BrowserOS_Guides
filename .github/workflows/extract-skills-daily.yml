name: Daily Skills Extraction from awesome-claude-skills

on:
  # Run daily at 02:00 UTC to extract new/updated skills
  schedule:
    - cron: '0 2 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose output'
        required: false
        default: 'true'
        type: boolean

# Required permissions
permissions:
  contents: write

jobs:
  extract-skills:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Extract skills from awesome-claude-skills
        run: |
          echo "ðŸŽ¯ Extracting skills from awesome-claude-skills repository..."
          echo "Repository: https://github.com/Grumpified-OGGVCT/awesome-claude-skills"
          
          if [ "${{ github.event.inputs.verbose }}" == "true" ] || [ "${{ github.event_name }}" == "schedule" ]; then
            python scripts/extract_claude_skills.py --verbose
          else
            python scripts/extract_claude_skills.py
          fi
        continue-on-error: false
      
      - name: Count extracted skills
        id: count_skills
        run: |
          SKILL_COUNT=$(find BrowserOS/Workflows/Community-Contributed/claude-skills-adapted -name "*.json" -type f | wc -l)
          echo "count=$SKILL_COUNT" >> $GITHUB_OUTPUT
          echo "ðŸ“Š Total skills extracted: $SKILL_COUNT"
      
      - name: Update search index with new skills
        run: |
          echo "ðŸ“Š Regenerating search index with new skills..."
          python scripts/generate_search_index.py || echo "âš ï¸ Search index update encountered issues"
        continue-on-error: true
      
      - name: Check for changes
        id: check_changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "âœ… New or updated skills detected"
            
            # Count new/modified files (improved pattern matching)
            NEW_COUNT=$(git status --porcelain | grep "^??" | wc -l)
            MODIFIED_COUNT=$(git status --porcelain | grep "^ M\|^M " | wc -l)
            echo "new_files=$NEW_COUNT" >> $GITHUB_OUTPUT
            echo "modified_files=$MODIFIED_COUNT" >> $GITHUB_OUTPUT
            echo "ðŸ“ New skills: $NEW_COUNT, Modified skills: $MODIFIED_COUNT"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No new skills detected"
          fi
      
      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          # Add all skill files
          git add BrowserOS/Workflows/Community-Contributed/claude-skills-adapted/
          git add docs/search-index.json
          
          # Generate detailed commit message
          COMMIT_MSG="ðŸŽ¯ Daily skills extraction - $(date +%Y-%m-%d)

          Automated extraction from awesome-claude-skills repository
          
          ðŸ“Š Statistics:
          - Total skills: ${{ steps.count_skills.outputs.count }}
          - New skills: ${{ steps.check_changes.outputs.new_files }}
          - Updated skills: ${{ steps.check_changes.outputs.modified_files }}
          
          Source: https://github.com/Grumpified-OGGVCT/awesome-claude-skills
          Credit: Composio HQ and awesome-claude-skills contributors
          License: Apache 2.0
          
          Generated by GitHub Actions workflow"
          
          git commit -m "$COMMIT_MSG"
          
          # Create daily tag for tracking
          TAG_NAME="skills-$(date +%Y.%m.%d)"
          git tag -a "$TAG_NAME" -m "Skills update $(date +%Y-%m-%d)" || echo "Tag may already exist"
          
          # Push changes and tags
          git push origin main
          git push origin "$TAG_NAME" || echo "Tag push skipped (may already exist)"
      
      - name: Create summary
        if: always()
        run: |
          echo "## ðŸŽ¯ Daily Skills Extraction Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source Repository**: [awesome-claude-skills](https://github.com/Grumpified-OGGVCT/awesome-claude-skills)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_changes.outputs.changes }}" == "true" ]; then
            echo "### âœ… Changes Detected and Committed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š **Total Skills**: ${{ steps.count_skills.outputs.count }}" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ†• **New Skills**: ${{ steps.check_changes.outputs.new_files }}" >> $GITHUB_STEP_SUMMARY
            echo "â™»ï¸ **Updated Skills**: ${{ steps.check_changes.outputs.modified_files }}" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ **Tag**: skills-$(date +%Y.%m.%d)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ No Changes Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š **Total Skills**: ${{ steps.count_skills.outputs.count }}" >> $GITHUB_STEP_SUMMARY
            echo "All skills are up to date." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ™ Credits" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: [Grumpified-OGGVCT/awesome-claude-skills](https://github.com/Grumpified-OGGVCT/awesome-claude-skills)" >> $GITHUB_STEP_SUMMARY
          echo "- **Maintainers**: Composio HQ and contributors" >> $GITHUB_STEP_SUMMARY
          echo "- **License**: Apache 2.0" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [View Skills Library](../tree/main/BrowserOS/Workflows/Community-Contributed/claude-skills-adapted)" >> $GITHUB_STEP_SUMMARY
